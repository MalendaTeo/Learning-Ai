<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Learning AI Platform</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* åŸºæœ¬è‡ªå®šç¾©æ¨£å¼ */
        body { background-color: #f4f7f6; font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; }
        .container { max-width: 960px; background: #fff; padding: 30px; margin-top: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        h1, h2, h3 { color: #2c3e50; }
        /* éš±è—å€å¡Š */
        #quiz-section, #result-section, #loading-overlay { display: none; }
        /* Loading é®ç½© */
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 9999; display: flex; justify-content: center; align-items: center; flex-direction: column; }
        /* è€ƒè©¦ä»‹é¢æ¨£å¼ */
        .question-card { border-left: 4px solid #0d6efd; padding: 20px; background: #f8f9fa; margin-bottom: 25px; border-radius: 8px; }
        .sub-question { margin-top: 15px; padding: 15px; background: #fff; border: 1px solid #dee2e6; border-radius: 6px; }
        .options-list .form-check { margin-bottom: 10px; padding: 10px 10px 10px 35px; border: 1px solid #e9ecef; border-radius: 6px; transition: all 0.2s; }
        .options-list .form-check:hover { background-color: #e9ecef; }
        .btn-primary { padding: 10px 25px; font-weight: 600; }
        /* è¨ºæ–·å ±å‘Šæ¨£å¼ */
        .diagnostic-report h3 { margin-top: 25px; border-bottom: 2px solid #0d6efd; padding-bottom: 10px; font-size: 1.3rem; }
        .diagnostic-report ul { padding-left: 20px; }
        .diagnostic-report li { margin-bottom: 10px; }
    </style>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <script>
    MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']], // é…ç½®è¡Œå…§å…¬å¼åˆ†éš”ç¬¦
        displayMath: [['$$', '$$'], ['\\[', '\\]']], // é…ç½®å€å¡Šå…¬å¼åˆ†éš”ç¬¦
        processEscapes: true
      },
      svg: {
        fontCache: 'global'
      }
    };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-svg.js"></script>
</head>
<body>

<div id="loading-overlay">
    <div class="spinner-border text-primary" role="status" style="width: 4rem; height: 4rem;">
        <span class="visually-hidden">Loading...</span>
    </div>
    <h4 class="mt-3" id="loading-text">AI æ­£åœ¨è™•ç†ä¸­ï¼Œè«‹ç¨å€™...</h4>
    <p class="text-muted">é€™å¯èƒ½éœ€è¦ 30-60 ç§’ï¼Œå–æ±ºæ–¼å…§å®¹é•·åº¦ã€‚</p>
</div>

<div class="container">
    <header class="d-flex flex-wrap justify-content-between align-items-center pb-3 mb-4 border-bottom">
        <a href="/" class="d-flex align-items-center text-dark text-decoration-none">
            <span class="fs-3 fw-bold">Learning AI (V1)</span>
        </a>
        <div class="dropdown">
             <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="langDropdown" data-bs-toggle="dropdown" aria-expanded="false">
               Language (Demo)
             </button>
             <ul class="dropdown-menu" aria-labelledby="langDropdown">
               <li><a class="dropdown-item" href="#">English</a></li>
               <li><a class="dropdown-item" href="#">ä¸­æ–‡(ç°¡)</a></li>
               <li><a class="dropdown-item" href="#">ä¸­æ–‡(ç¹)</a></li>
               <li><a class="dropdown-item" href="#">Bahasa Melayu</a></li>
             </ul>
        </div>
    </header>

    <div id="upload-section">
        <h2 class="mb-4">æ•™å¸«å¾Œå°ï¼šèª²æ–‡ä¸Šå‚³èˆ‡å‘½é¡Œ</h2>
        <p class="text-muted">è«‹å¡«å¯«èª²æ–‡è³‡è¨Šä¸¦è²¼ä¸Šç´”æ–‡å­—å…§å®¹ï¼ŒAI å°‡è‡ªå‹•ç‚ºæ‚¨ç”Ÿæˆè©¦é¡Œã€‚</p>
        <form id="uploadForm">
            <div class="row g-3 mb-3">
                <div class="col-md-6">
                    <label for="stage" class="form-label">å­¸ç¿’éšæ®µ</label>
                    <select class="form-select" id="stage" name="stage" required>
                        <option value="é«˜ä¸­" selected>é«˜ä¸­ (Senior High)</option>
                        <option value="åˆä¸­">åˆä¸­ (Junior High)</option>
                    </select>
                </div>
                <div class="col-md-6">
                    <label for="grade" class="form-label">å¹´ç´š</label>
                    <select class="form-select" id="grade" name="grade" required>
                        <option value="é«˜ä¸€">é«˜ä¸€ / åˆä¸€</option>
                        <option value="é«˜äºŒ" selected>é«˜äºŒ / åˆäºŒ</option>
                        <option value="é«˜ä¸‰">é«˜ä¸‰ / åˆä¸‰</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label for="subject" class="form-label">ç§‘ç›®</label>
                    <input type="text" class="form-control" id="subject" name="subject" placeholder="ä¾‹å¦‚ï¼šåŒ–å­¸" required>
                </div>
                <div class="col-md-4">
                    <label for="volume" class="form-label">å†Šåˆ¥</label>
                    <input type="text" class="form-control" id="volume" name="volume" placeholder="ä¾‹å¦‚ï¼šç¬¬äºŒå†Š">
                </div>
                <div class="col-md-4">
                    <label for="lessonNum" class="form-label">èª²åˆ¥</label>
                    <input type="text" class="form-control" id="lessonNum" name="lessonNum" placeholder="ä¾‹å¦‚ï¼šCh 5">
                </div>
                <div class="col-12">
                    <label for="lessonName" class="form-label">èª²å</label>
                    <input type="text" class="form-control" id="lessonName" name="lessonName" placeholder="ä¾‹å¦‚ï¼šæ°§åŒ–é‚„åŸåæ‡‰" required>
                </div>
            </div>

            <div class="mb-3">
                <label for="contentBody" class="form-label">èª²æ–‡å…§å®¹ (ç´”æ–‡å­—)</label>
                <textarea class="form-control" id="contentBody" name="contentBody" rows="10" placeholder="è«‹åœ¨æ­¤è²¼ä¸Šèª²æ–‡çš„ç´”æ–‡å­—å…§å®¹ã€‚æš«ä¸æ”¯æŒåœ–ç‰‡æˆ– PDF ç›´æ¥ä¸Šå‚³ã€‚" required></textarea>
            </div>

            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                <button type="submit" class="btn btn-primary btn-lg">æäº¤ä¸¦ç”Ÿæˆè©¦é¡Œ</button>
            </div>
        </form>
    </div>


    <div id="quiz-section">
        <div class="d-flex justify-content-between align-items-center mb-4">
             <h2 id="quiz-title">éš¨å ‚æ¸¬é©—</h2>
             <span class="badge bg-secondary fs-5" id="progress-badge">é€²åº¦: 1 / 10</span>
        </div>
        <div class="progress mb-4" style="height: 5px;">
            <div class="progress-bar" id="progress-bar-visual" role="progressbar" style="width: 0%"></div>
        </div>

        <div id="question-container">
            </div>

        <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
            <button id="next-btn" class="btn btn-primary btn-lg">ä¸‹ä¸€é¡Œ</button>
        </div>
    </div>


    <div id="result-section">
         <div class="text-center mb-5">
            <h2>æ¸¬é©—çµæœèˆ‡ AI è¨ºæ–·å ±å‘Š</h2>
            <p class="lead text-muted">ä»¥ä¸‹æ˜¯æ‚¨çš„ AI å­¸ç¿’è¨ºç™‚é†«å¸«ç‚ºæ‚¨æä¾›çš„åˆ†æã€‚</p>
            <div class="display-4 fw-bold text-primary" id="score-display">-- / 100</div>
            <span class="badge bg-warning text-dark">(è¨»: ç›®å‰åƒ…åŒ…å«é¸æ“‡é¡Œå¾—åˆ†)</span>
        </div>

        <div class="card">
            <div class="card-header bg-primary text-white fw-bold">
                ğŸ©º AI é†«å¸«è¨ºæ–·å ±å‘Š (Dr. AI Diagnostic Report)
            </div>
            <div class="card-body diagnostic-report" id="diagnostic-content">
                <p>æ­£åœ¨è¼‰å…¥è¨ºæ–·å ±å‘Š...</p>
            </div>
        </div>

        <div class="text-center mt-5">
             <button class="btn btn-outline-primary" onclick="location.reload()">è¿”å›é¦–é  (é–‹å§‹æ–°æ¸¬é©—)</button>
        </div>
    </div>

</div> <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>


<script>
// ================= å…¨åŸŸè®Šæ•¸æ§åˆ¶è€ƒè©¦æµç¨‹ =================
let currentQuizData = [];
let currentQuestionIndex = 0;
let studentAnswers = [];
let currentLessonId = null;

$(document).ready(function() {
    // ç¶å®šä¸Šå‚³è¡¨å–®æäº¤äº‹ä»¶
    $('#uploadForm').on('submit', function(e) {
        e.preventDefault();
        showLoading('AI æ­£åœ¨é–±è®€èª²æ–‡ä¸¦åŠªåŠ›å‘½é¡Œä¸­ (ç´„éœ€ 30-60 ç§’)...');
        
        // ç²å–è¡¨å–®è³‡æ–™
        const formData = {
            stage: $('#stage').val(),
            grade: $('#grade').val(),
            subject: $('#subject').val(),
            volume: $('#volume').val(),
            lessonNum: $('#lessonNum').val(),
            lessonName: $('#lessonName').val(),
            contentBody: $('#contentBody').val()
        };

        // å‘¼å«å¾Œç«¯ GAS å‡½æ•¸
        google.script.run
            .withSuccessHandler(function(response) {
                hideLoading();
                if (response.status === 'success') {
                    alert(response.message);
                    // é–‹å§‹è€ƒè©¦æµç¨‹
                    currentLessonId = response.lessonId;
                    startQuiz(response.quizData);
                } else {
                    alert('éŒ¯èª¤: ' + response.message);
                }
            })
            .withFailureHandler(function(error) {
                hideLoading();
                alert('ä¼ºæœå™¨éŒ¯èª¤: ' + error.message);
            })
            .handleUpload(formData);
    });

    // ç¶å®šä¸‹ä¸€é¡ŒæŒ‰éˆ•äº‹ä»¶
    $('#next-btn').on('click', nextQuestion);
});

// é¡¯ç¤º Loading é®ç½©
function showLoading(text) {
    $('#loading-text').text(text || 'Loading...');
    $('#loading-overlay').fadeIn();
}
// éš±è— Loading é®ç½©
function hideLoading() {
    $('#loading-overlay').fadeOut();
}

// ================= è€ƒè©¦æµç¨‹å‡½æ•¸ =================

// é–‹å§‹è€ƒè©¦ï¼šåˆå§‹åŒ–ç‹€æ…‹ä¸¦åˆ‡æ›ä»‹é¢
function startQuiz(questions) {
    currentQuizData = questions;
    currentQuestionIndex = 0;
    studentAnswers = [];
    
    // åˆ‡æ›ä»‹é¢
    $('#upload-section').hide();
    $('#result-section').hide();
    $('#quiz-section').fadeIn();

    renderQuestion();
}

// æ¸²æŸ“ç•¶å‰é¡Œç›®
function renderQuestion() {
    const question = currentQuizData[currentQuestionIndex];
    const $container = $('#question-container');
    $container.empty(); // æ¸…ç©ºèˆŠé¡Œ

    // æ›´æ–°é€²åº¦æ¢
    const progressText = `é€²åº¦: ${currentQuestionIndex + 1} / ${currentQuizData.length}`;
    $('#progress-badge').text(progressText);
    const progressPercent = ((currentQuestionIndex + 1) / currentQuizData.length) * 100;
    $('#progress-bar-visual').css('width', progressPercent + '%');

    // æ›´æ–°æŒ‰éˆ•æ–‡å­—
    if (currentQuestionIndex === currentQuizData.length - 1) {
        $('#next-btn').text('æŸ¥çœ‹çµæœ (æäº¤)');
    } else {
        $('#next-btn').text('ä¸‹ä¸€é¡Œ');
    }

    let html = '';
    
    // æ ¹æ“šé¡Œå‹ç”Ÿæˆä¸åŒçš„ HTML çµæ§‹
    if (question.type === 'MCQ') {
        html = `
            <div class="question-card">
                <div class="mb-3">
                    <span class="badge bg-info text-dark mb-2">${question.context_tag || 'General'}</span>
                    <span class="badge bg-secondary mb-2">${question.difficulty} | ${question.marks} åˆ†</span>
                    <h5 class="card-title fw-bold">${question.question_text}</h5>
                </div>
                <div class="options-list">
                    ${Object.entries(question.options).map(([key, value]) => `
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="mcq-option" id="option${key}" value="${key}">
                            <label class="form-check-label w-100" for="option${key}">
                                <strong>${key}.</strong> ${value}
                            </label>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    } else if (question.type === 'EIQ_GROUP' || question.type === 'SAQ_GROUP') {
        // é¡Œçµ„å‹ (å¯¦é©—é¡Œæˆ–ç°¡ç­”é¡Œ)
        html = `
            <div class="question-card">
                <div class="mb-3">
                    <span class="badge bg-warning text-dark mb-2">é¡Œçµ„ | ${question.marks} åˆ†ç¸½åˆ†</span>
                    <h5 class="card-title fw-bold">${question.main_text}</h5>
                </div>
                ${question.sub_questions.map(subQ => `
                    <div class="sub-question" data-sub-id="${subQ.sub_id}">
                        <label class="form-label fw-bold">${subQ.question_text} (${subQ.marks} åˆ†)</label>
                        <textarea class="form-control" rows="3" placeholder="è«‹åœ¨æ­¤è¼¸å…¥æ‚¨çš„ç­”æ¡ˆ..."></textarea>
                    </div>
                `).join('')}
            </div>
        `;
    }

    $container.html(html);

    // ã€é‡è¦ã€‘é€šçŸ¥ MathJax é‡æ–°æ¸²æŸ“æ–°æ’å…¥çš„å…§å®¹ä¸­çš„å…¬å¼
    if (window.MathJax) {
        MathJax.typesetPromise && MathJax.typesetPromise([$container[0]]);
    }
}

// è™•ç†ä¸‹ä¸€é¡Œé‚è¼¯
function nextQuestion() {
    const question = currentQuizData[currentQuestionIndex];
    
    // 1. æ”¶é›†ç•¶å‰ç­”æ¡ˆ
    if (question.type === 'MCQ') {
        const selectedOption = $('input[name="mcq-option"]:checked').val();
        if (!selectedOption) {
            alert('è«‹é¸æ“‡ä¸€å€‹é¸é …ï¼');
            return;
        }
        studentAnswers.push({
            question_id: question.id,
            student_response: selectedOption
        });
    } else {
        // æ”¶é›†é¡Œçµ„çš„æ‰€æœ‰å°é¡Œç­”æ¡ˆ
        const subAnswers = [];
        $('#question-container .sub-question').each(function() {
            const subId = $(this).data('sub-id');
            const textVal = $(this).find('textarea').val();
            if (textVal.trim() === "") {
                 // é€™è£¡å¯ä»¥é¸æ“‡æ˜¯å¦å¼·åˆ¶å­¸ç”Ÿä½œç­”ï¼ŒV1 æš«æ™‚å…è¨±ç•™ç©º
            }
            subAnswers.push({ sub_id: subId, response: textVal });
        });
        // å°‡è¤‡é›œçš„é¡Œçµ„ç­”æ¡ˆè½‰æ›ç‚ºå­—ä¸²å„²å­˜ï¼Œä»¥ä¾¿å¾Œç«¯è™•ç† (ç°¡åŒ– V1)
        studentAnswers.push({
            question_id: question.id,
            student_response: JSON.stringify(subAnswers) 
        });
    }

    // 2. åˆ¤æ–·æ˜¯å¦çµæŸ
    if (currentQuestionIndex < currentQuizData.length - 1) {
        currentQuestionIndex++;
        renderQuestion();
    } else {
        // æäº¤è©¦å·
        submitQuiz();
    }
}

// æäº¤è©¦å·ä¸¦ç²å–çµæœ
function submitQuiz() {
    showLoading('æ­£åœ¨æ‰¹æ”¹è©¦å·ä¸¦é€²è¡Œ AI è¨ºæ–· (ç´„éœ€ 60 ç§’)...');

    const submissionData = {
        lessonId: currentLessonId,
        studentName: 'æ¸¬è©¦å­¸ç”Ÿ (V1)', // V1 æš«æ™‚å¯«æ­»
        answers: studentAnswers
    };

    google.script.run
        .withSuccessHandler(function(response) {
            hideLoading();
            if (response.status === 'success') {
                showResults(response);
            } else {
                alert('æ‰¹æ”¹å¤±æ•—: ' + response.message);
            }
        })
        .withFailureHandler(function(error) {
            hideLoading();
            alert('æäº¤æ™‚ç™¼ç”ŸéŒ¯èª¤: ' + error.message);
        })
        .handleGrading(submissionData);
}

// é¡¯ç¤ºçµæœé é¢
function showResults(data) {
    $('#quiz-section').hide();
    $('#result-section').fadeIn();

    $('#score-display').text(`${data.mcqScore} / 100`);
    // æ’å…¥ AI ç”Ÿæˆçš„ HTML è¨ºæ–·å ±å‘Š
    $('#diagnostic-content').html(data.diagnostic);
}

</script>
</body>
</html>

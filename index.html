<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Learning AI Platform | 智能學習診斷系統</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    
    <style>
        :root {
            --primary-color: #4f46e5; /* 現代靛藍 */
            --primary-hover: #4338ca;
            --bg-color: #f3f4f6;
            --card-bg: #ffffff;
            --text-main: #1f2937;
            --text-muted: #6b7280;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        body {
            background-color: var(--bg-color);
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            color: var(--text-main);
            line-height: 1.6;
            padding-bottom: 50px;
        }

        /* 導航列 */
        .navbar-custom {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(0,0,0,0.05);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .brand-logo {
            font-weight: 700;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* 主容器 */
        .main-container {
            max-width: 900px;
            margin: 40px auto;
            padding: 0 20px;
        }

        /* 通用卡片 */
        .custom-card {
            background: var(--card-bg);
            border-radius: 16px;
            box-shadow: var(--shadow-lg);
            border: none;
            padding: 40px;
            margin-bottom: 30px;
            transition: opacity 0.3s ease;
        }

        .section-title {
            font-weight: 700;
            color: #111827;
            margin-bottom: 20px;
            position: relative;
            display: inline-block;
        }
        
        .section-title::after {
            content: '';
            display: block;
            width: 50px;
            height: 4px;
            background: var(--primary-color);
            margin-top: 8px;
            border-radius: 2px;
        }

        /* 表單元件 */
        .form-label {
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
        }

        .form-control, .form-select {
            border-radius: 10px;
            border: 1px solid #d1d5db;
            padding: 12px 15px;
            font-size: 0.95rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .form-control:focus, .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.1);
            outline: none;
        }

        /* 按鈕 */
        .btn-primary {
            background-color: var(--primary-color);
            border: none;
            border-radius: 10px;
            padding: 12px 30px;
            font-weight: 600;
            box-shadow: 0 4px 6px rgba(79, 70, 229, 0.2);
            transition: all 0.2s;
        }

        .btn-primary:hover {
            background-color: var(--primary-hover);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(79, 70, 229, 0.3);
        }

        /* Loading 遮罩 */
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            z-index: 9999;
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            backdrop-filter: blur(5px);
        }

        /* 題目樣式 */
        .question-card {
            border: 1px solid #e5e7eb;
            border-left: 5px solid var(--primary-color);
            background: #f9fafb;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .form-check {
            background: white;
            border: 1px solid #e5e7eb;
            padding: 15px 15px 15px 45px;
            border-radius: 8px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: border-color 0.2s;
        }

        .form-check:hover {
            border-color: var(--primary-color);
            background-color: #fefeff;
        }

        .form-check-input:checked + .form-check-label {
            color: var(--primary-color);
            font-weight: 700;
        }

        /* 結果報告 */
        .diagnostic-report h3 {
            color: var(--primary-color);
            margin-top: 30px;
            font-weight: 700;
            font-size: 1.3rem;
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        
        .diagnostic-report ul {
            padding-left: 20px;
            color: #4b5563;
        }
        
        .diagnostic-report li {
            margin-bottom: 8px;
        }

        /* 隱藏輔助 */
        .d-none-custom { display: none !important; }
        
        /* 動畫 */
        .fade-in { animation: fadeIn 0.5s ease forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>

    <script>
    MathJax = {
      tex: { inlineMath: [['$', '$'], ['\\(', '\\)']] },
      svg: { fontCache: 'global' }
    };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-svg.js"></script>
</head>
<body>

<div id="loading-overlay">
    <div class="text-center">
        <div class="spinner-border text-primary mb-4" role="status" style="width: 3.5rem; height: 3.5rem;"></div>
        <h4 class="fw-bold mb-2" id="loading-title" data-i18n="loading_title">AI 正在深度分析教材...</h4>
        <p class="text-muted" id="loading-desc" data-i18n="loading_desc">這可能需要 30-60 秒，請稍候...</p>
    </div>
</div>

<nav class="navbar navbar-custom">
    <div class="container-fluid max-width-900">
        <div class="main-container w-100 my-0 py-2 d-flex justify-content-between align-items-center">
            <a href="#" class="brand-logo text-decoration-none fs-4" onclick="location.reload()">
                <i class="bi bi-robot"></i> <span data-i18n="brand">Learning AI</span>
            </a>
            <div class="dropdown">
                <button class="btn btn-outline-primary dropdown-toggle btn-sm" type="button" id="langDropdown" data-bs-toggle="dropdown">
                    <i class="bi bi-globe"></i> <span id="current-lang-text">繁體中文</span>
                </button>
                <ul class="dropdown-menu dropdown-menu-end shadow">
                    <li><button class="dropdown-item lang-select" data-lang="en">English</button></li>
                    <li><button class="dropdown-item lang-select" data-lang="zh_cn">简体中文</button></li>
                    <li><button class="dropdown-item lang-select" data-lang="zh_tw">繁體中文</button></li>
                    <li><button class="dropdown-item lang-select" data-lang="ms">Bahasa Melayu</button></li>
                </ul>
            </div>
        </div>
    </div>
</nav>

<div class="container main-container">

    <div id="upload-section" class="custom-card fade-in">
        <h2 class="section-title" data-i18n="upload_title">教師後台：課文上傳與命題</h2>
        <p class="text-muted mb-4" data-i18n="upload_desc">請填寫課文資訊並貼上純文字內容，AI 將自動為您生成診斷試題。</p>
        
        <form id="uploadForm">
            <div class="row g-4 mb-4">
                <div class="col-md-6">
                    <label for="stage" class="form-label" data-i18n="label_stage">學習階段</label>
                    <select class="form-select" id="stage" name="stage" required>
                        <option value="高中" selected data-i18n="opt_senior">高中 (Senior High)</option>
                        <option value="初中" data-i18n="opt_junior">初中 (Junior High)</option>
                    </select>
                </div>
                <div class="col-md-6">
                    <label for="grade" class="form-label" data-i18n="label_grade">年級</label>
                    <select class="form-select" id="grade" name="grade" required>
                        </select>
                </div>

                <div class="col-md-4">
                    <label for="subject" class="form-label" data-i18n="label_subject">科目</label>
                    <input type="text" class="form-control" id="subject" name="subject" placeholder="Chemistry / Fizik" required>
                </div>
                <div class="col-md-4">
                    <label for="volume" class="form-label" data-i18n="label_volume">冊別</label>
                    <input type="text" class="form-control" id="volume" name="volume" placeholder="Vol 2">
                </div>
                <div class="col-md-4">
                    <label for="lessonNum" class="form-label" data-i18n="label_chapter">課別</label>
                    <input type="text" class="form-control" id="lessonNum" name="lessonNum" placeholder="Chapter 5">
                </div>
                <div class="col-12">
                    <label for="lessonName" class="form-label" data-i18n="label_lesson_name">課名</label>
                    <input type="text" class="form-control" id="lessonName" name="lessonName" placeholder="Redox Reaction" required>
                </div>
            </div>

            <div class="mb-4">
                <label for="contentBody" class="form-label" data-i18n="label_content">課文內容 (純文字)</label>
                <textarea class="form-control font-monospace" id="contentBody" name="contentBody" rows="12" placeholder="..." required style="background-color: #fafafa; font-size: 0.95rem;"></textarea>
                <div class="form-text text-end mt-2">
                    <i class="bi bi-info-circle"></i> <span data-i18n="hint_content">暫不支持圖片或 PDF，請貼上純文本。</span>
                </div>
            </div>

            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                <button type="submit" class="btn btn-primary btn-lg px-5">
                    <i class="bi bi-stars"></i> <span data-i18n="btn_submit">提交並生成試題</span>
                </button>
            </div>
        </form>
    </div>

    <div id="quiz-section" class="custom-card fade-in d-none-custom">
        <div class="d-flex justify-content-between align-items-center mb-4">
             <div>
                 <h3 id="quiz-title" class="mb-1 fw-bold">隨堂測驗</h3>
                 <small class="text-muted" data-i18n="quiz_subtitle">請仔細作答，AI 將分析您的概念理解。</small>
             </div>
             <span class="badge bg-primary fs-6 rounded-pill px-3 py-2" id="progress-badge">1 / 10</span>
        </div>
        
        <div class="progress mb-4" style="height: 10px;">
            <div class="progress-bar" id="progress-bar-visual" role="progressbar" style="width: 0%"></div>
        </div>

        <div id="question-container">
            </div>

        <div class="d-flex justify-content-end mt-4 pt-3 border-top">
            <button id="next-btn" class="btn btn-primary px-5">
                <span data-i18n="btn_next">下一題</span> <i class="bi bi-arrow-right"></i>
            </button>
        </div>
    </div>

    <div id="result-section" class="custom-card fade-in d-none-custom">
         <div class="text-center mb-5">
            <div class="mb-3">
                <i class="bi bi-clipboard-pulse text-primary" style="font-size: 4rem;"></i>
            </div>
            <h2 class="fw-bold" data-i18n="result_title">測驗結果與 AI 診斷報告</h2>
            <p class="text-muted" data-i18n="result_desc">以下是您的專屬學習診療醫師為您提供的分析。</p>
            
            <div class="d-inline-block bg-light px-5 py-3 rounded-4 mt-3 border">
                <div class="display-4 fw-bold text-primary" id="score-display">-- / 100</div>
                <small class="text-secondary fw-bold text-uppercase">Score (MCQ)</small>
            </div>
        </div>

        <div class="card border-0 shadow-sm">
            <div class="card-header bg-primary text-white fw-bold py-3">
                <i class="bi bi-activity"></i> <span data-i18n="report_header">AI 醫師診斷報告 (Dr. AI Diagnostic Report)</span>
            </div>
            <div class="card-body diagnostic-report p-4" id="diagnostic-content">
                </div>
        </div>

        <div class="text-center mt-5">
             <button class="btn btn-outline-primary px-4 py-2 rounded-pill" onclick="location.reload()">
                <i class="bi bi-arrow-counterclockwise"></i> <span data-i18n="btn_restart">返回首頁 (開始新測驗)</span>
             </button>
        </div>
    </div>

</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
/**
 * =========================================================
 * 系統設定與全域變數
 * =========================================================
 */
// 真實可用的 GAS API URL (請勿修改，除非您部署了新版本)
const GAS_API_URL = 'https://script.google.com/macros/s/AKfycbxfXHBE_m2123QWM5sM9-uH0LcaX5lLyoLJmKRR1QHFh1yiQOXUbsYQhlOZZNs7H4FWjA/exec';

let currentQuizData = [];
let currentQuestionIndex = 0;
let studentAnswers = [];
let currentLessonId = null;
let currentLang = 'zh_tw'; // 預設語言

// 語言包
const translations = {
    'zh_tw': {
        brand: "Learning AI", loading_title: "AI 正在深度分析教材...", loading_desc: "這可能需要 30-60 秒，請稍候...",
        upload_title: "教師後台：課文上傳與命題", upload_desc: "請填寫課文資訊並貼上純文字內容，AI 將自動為您生成診斷試題。",
        label_stage: "學習階段", label_grade: "年級", label_subject: "科目", label_volume: "冊別",
        label_chapter: "課別", label_lesson_name: "課名", label_content: "課文內容 (純文字)",
        opt_senior: "高中 (Senior High)", opt_junior: "初中 (Junior High)",
        hint_content: "暫不支持圖片或 PDF，請貼上純文本。", btn_submit: "提交並生成試題",
        quiz_subtitle: "請仔細作答，AI 將分析您的概念理解。", btn_next: "下一題", btn_result: "查看結果 (提交)",
        result_title: "測驗結果與 AI 診斷報告", result_desc: "以下是您的專屬學習診療醫師為您提供的分析。",
        report_header: "AI 醫師診斷報告", btn_restart: "返回首頁"
    },
    'zh_cn': {
        brand: "Learning AI", loading_title: "AI 正在深度分析教材...", loading_desc: "这可能需要 30-60 秒，请稍候...",
        upload_title: "教师后台：课文上传与命题", upload_desc: "请填写课文资讯并贴上纯文字内容，AI 将自动为您生成诊断试题。",
        label_stage: "学习阶段", label_grade: "年级", label_subject: "科目", label_volume: "册别",
        label_chapter: "课别", label_lesson_name: "课名", label_content: "课文内容 (纯文字)",
        opt_senior: "高中 (Senior High)", opt_junior: "初中 (Junior High)",
        hint_content: "暂不支持图片或 PDF，请贴上纯文本。", btn_submit: "提交并生成试题",
        quiz_subtitle: "请仔细作答，AI 将分析您的概念理解。", btn_next: "下一题", btn_result: "查看结果 (提交)",
        result_title: "测验结果与 AI 诊断报告", result_desc: "以下是您的专属学习诊疗医师为您提供的分析。",
        report_header: "AI 医师诊断报告", btn_restart: "返回首页"
    },
    'en': {
        brand: "Learning AI", loading_title: "AI Analyzing Content...", loading_desc: "This may take 30-60 seconds, please wait...",
        upload_title: "Teacher Portal: Upload & Generate", upload_desc: "Paste text content. AI will generate diagnostic questions.",
        label_stage: "Stage", label_grade: "Grade", label_subject: "Subject", label_volume: "Volume",
        label_chapter: "Chapter", label_lesson_name: "Lesson Name", label_content: "Content (Text Only)",
        opt_senior: "Senior High", opt_junior: "Junior High",
        hint_content: "Paste plain text here.", btn_submit: "Generate Quiz",
        quiz_subtitle: "AI is analyzing your understanding.", btn_next: "Next", btn_result: "Submit",
        result_title: "Quiz Results & Diagnosis", result_desc: "Here is your AI Learning Doctor's analysis.",
        report_header: "Dr. AI Diagnostic Report", btn_restart: "Back to Home"
    },
    'ms': {
        brand: "Learning AI", loading_title: "AI Menganalisis...", loading_desc: "Sila tunggu 30-60 saat...",
        upload_title: "Portal Guru: Muat Naik", upload_desc: "Tampal teks. AI akan menjana soalan.",
        label_stage: "Peringkat", label_grade: "Tingkatan", label_subject: "Subjek", label_volume: "Jilid",
        label_chapter: "Bab", label_lesson_name: "Tajuk", label_content: "Kandungan (Teks)",
        opt_senior: "Sekolah Menengah Atas", opt_junior: "Sekolah Menengah Rendah",
        hint_content: "Tampal teks biasa di sini.", btn_submit: "Jana Kuiz",
        quiz_subtitle: "AI sedang menganalisis kefahaman anda.", btn_next: "Seterusnya", btn_result: "Hantar",
        result_title: "Keputusan & Diagnosis", result_desc: "Analisis Doktor AI anda.",
        report_header: "Laporan Diagnostik Dr. AI", btn_restart: "Kembali"
    }
};

/**
 * =========================================================
 * 初始化與事件綁定 (jQuery)
 * =========================================================
 */
$(document).ready(function() {
    // 1. 初始化介面
    setLanguage('zh_tw');
    updateGradeOptions(); // 初始化年級選單

    // 2. 綁定語言切換 (修復點：使用類別選擇器而非 inline onclick)
    $('.lang-select').on('click', function(e) {
        e.preventDefault();
        const selectedLang = $(this).data('lang');
        setLanguage(selectedLang);
    });

    // 3. 綁定學習階段變更 (修復點：真實連動年級選單)
    $('#stage').on('change', function() {
        updateGradeOptions();
    });

    // 4. 綁定表單提交 (AJAX)
    $('#uploadForm').on('submit', handleFormSubmit);

    // 5. 綁定下一題按鈕
    $('#next-btn').on('click', nextQuestion);
});

/**
 * =========================================================
 * 功能函數
 * =========================================================
 */

// 切換語言
function setLanguage(lang) {
    currentLang = lang;
    const t = translations[lang];
    const langNames = {'zh_tw': '繁體中文', 'zh_cn': '简体中文', 'en': 'English', 'ms': 'Bahasa Melayu'};

    // 更新下拉選單顯示文字
    $('#current-lang-text').text(langNames[lang]);

    // 更新所有帶有 data-i18n 的元素
    $('[data-i18n]').each(function() {
        const key = $(this).data('i18n');
        if (t[key]) $(this).text(t[key]);
    });

    // 更新 Placeholder
    $('#subject').attr('placeholder', lang === 'en' ? 'Chemistry' : '例如：化學');
    $('#contentBody').attr('placeholder', t.hint_content);
}

// 更新年級選單 (真實參數連動)
function updateGradeOptions() {
    const stage = $('#stage').val(); // 獲取當前選擇
    const $gradeSelect = $('#grade');
    $gradeSelect.empty(); // 清空舊選項

    let options = [];
    // 判斷邏輯：支援多語系的值
    if (stage === '高中' || stage === 'Senior High' || stage === 'Sekolah Menengah Atas') {
        options = [
            {val: '高一', text: 'Form 4 (高一)'},
            {val: '高二', text: 'Form 5 (高二)'},
            {val: '高三', text: 'Form 6 (高三)'}
        ];
    } else {
        options = [
            {val: '初一', text: 'Form 1 (初一)'},
            {val: '初二', text: 'Form 2 (初二)'},
            {val: '初三', text: 'Form 3 (初三)'}
        ];
    }

    // 動態生成選項
    options.forEach(opt => {
        $gradeSelect.append(`<option value="${opt.val}">${opt.text}</option>`);
    });
    // 預設選中第二個 (高二/初二)
    $gradeSelect.prop('selectedIndex', 1);
}

// 處理表單提交
function handleFormSubmit(e) {
    e.preventDefault();
    
    // 顯示 Loading
    $('#loading-overlay').css('display', 'flex').hide().fadeIn(300);

    const formData = {
        stage: $('#stage').val(),
        grade: $('#grade').val(),
        subject: $('#subject').val(),
        volume: $('#volume').val(),
        lessonNum: $('#lessonNum').val(),
        lessonName: $('#lessonName').val(),
        contentBody: $('#contentBody').val(),
        // 【關鍵修復】將前端語言偏好傳送給後端，告知 AI 輸出語言
        userLanguage: currentLang 
    };

    // 發送請求
    $.ajax({
        url: GAS_API_URL,
        type: "POST",
        contentType: "text/plain; charset=utf-8", // 避免 CORS Preflight
        dataType: "json",
        data: JSON.stringify({ action: 'upload', payload: formData }),
        success: function(response) {
            $('#loading-overlay').fadeOut(300);
            if (response.status === 'success') {
                currentLessonId = response.lessonId;
                startQuiz(response.quizData);
            } else {
                alert('系統錯誤: ' + response.message);
            }
        },
        error: function(xhr, status, error) {
            $('#loading-overlay').fadeOut(300);
            console.error(error);
            alert('連線失敗，請檢查網路狀態。');
        }
    });
}

// 開始測驗
function startQuiz(questions) {
    currentQuizData = questions;
    currentQuestionIndex = 0;
    studentAnswers = [];

    $('#upload-section').fadeOut(300, function() {
        $('#result-section').addClass('d-none-custom');
        $('#quiz-section').removeClass('d-none-custom').hide().fadeIn(300);
        renderQuestion();
    });
}

// 渲染題目
function renderQuestion() {
    const question = currentQuizData[currentQuestionIndex];
    const $container = $('#question-container');

    $container.fadeOut(200, function() {
        $container.empty();

        // UI 更新
        const t = translations[currentLang];
        $('#progress-badge').text(`${currentQuestionIndex + 1} / ${currentQuizData.length}`);
        $('#progress-bar-visual').css('width', ((currentQuestionIndex + 1) / currentQuizData.length) * 100 + '%');
        
        const btnText = (currentQuestionIndex === currentQuizData.length - 1) 
                        ? (t.btn_result || "提交") 
                        : (t.btn_next || "下一題");
        $('#next-btn').html(`${btnText} <i class="bi bi-arrow-right"></i>`);

        // 題目 HTML 生成
        let html = '';
        if (question.type === 'MCQ') {
            html = `
                <div class="question-card">
                    <div class="mb-4">
                        <span class="badge bg-info text-dark bg-opacity-25 border border-info mb-2">${question.difficulty || 'Normal'}</span>
                        <h5 class="fw-bold mt-2 lh-base">${question.question_text}</h5>
                    </div>
                    <div class="options-list">
                        ${Object.entries(question.options).map(([k, v]) => `
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="mcq" id="opt${k}" value="${k}">
                                <label class="form-check-label w-100" for="opt${k}">
                                    <strong class="text-primary me-2">${k}.</strong> ${v}
                                </label>
                            </div>`).join('')}
                    </div>
                </div>`;
        } else {
             // 簡答/題組題支援
             html = `
                <div class="question-card">
                    <h5 class="fw-bold mb-3">${question.main_text}</h5>
                    ${question.sub_questions ? question.sub_questions.map(sq => `
                        <div class="mb-3">
                            <label class="fw-bold d-block mb-1">${sq.question_text} (${sq.marks}m)</label>
                            <textarea class="form-control" rows="2"></textarea>
                        </div>`).join('') : ''}
                </div>`;
        }
        
        $container.html(html).fadeIn(200);
        
        // MathJax 渲染
        if (window.MathJax && MathJax.typesetPromise) {
            MathJax.typesetPromise([$container[0]]);
        }
    });
}

// 下一題 / 提交
function nextQuestion() {
    const q = currentQuizData[currentQuestionIndex];
    
    // 收集答案
    if (q.type === 'MCQ') {
        const val = $('input[name="mcq"]:checked').val();
        if (!val) {
            alert(currentLang === 'en' ? 'Please select an answer.' : '請選擇一個答案');
            return;
        }
        studentAnswers.push({ question_id: q.id, student_response: val });
    } else {
        // 非選題暫時存為固定字串 (V1)
        studentAnswers.push({ question_id: q.id, student_response: "Subjective Answer" });
    }

    if (currentQuestionIndex < currentQuizData.length - 1) {
        currentQuestionIndex++;
        renderQuestion();
    } else {
        submitQuizResult();
    }
}

// 提交結果並獲取診斷
function submitQuizResult() {
    const t = translations[currentLang];
    $('#loading-title').text(t.brand); // 簡單顯示 Loading
    $('#loading-desc').text("Dr. AI is writing diagnosis...");
    $('#loading-overlay').fadeIn();

    const submissionData = {
        lessonId: currentLessonId,
        studentName: 'Student V3',
        answers: studentAnswers,
        userLanguage: currentLang
    };

    $.ajax({
        url: GAS_API_URL,
        type: "POST",
        contentType: "text/plain; charset=utf-8",
        dataType: "json",
        data: JSON.stringify({ action: 'grading', payload: submissionData }),
        success: function(response) {
            $('#loading-overlay').fadeOut();
            if (response.status === 'success') {
                showResults(response);
            } else {
                alert('Error: ' + response.message);
            }
        },
        error: function() {
            $('#loading-overlay').fadeOut();
            alert('Submission failed.');
        }
    });
}

// 顯示結果
function showResults(data) {
    $('#quiz-section').addClass('d-none-custom');
    $('#result-section').removeClass('d-none-custom').hide().fadeIn(500);
    
    $('#score-display').text(`${data.mcqScore} / 100`);
    $('#diagnostic-content').html(data.diagnostic);
    
    window.scrollTo({top: 0, behavior: 'smooth'});
}
</script>
</body>
</html>

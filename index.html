<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Learning AI Platform | 智能學習診斷系統</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    
    <style>
        :root {
            --primary-color: #4f46e5; /* 現代靛藍 */
            --primary-hover: #4338ca;
            --bg-color: #f3f4f6;
            --card-bg: #ffffff;
            --text-main: #1f2937;
            --text-muted: #6b7280;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        body {
            background-color: var(--bg-color);
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            color: var(--text-main);
            line-height: 1.6;
        }

        /* 頂部導航 */
        .navbar-custom {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(0,0,0,0.05);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .brand-logo {
            font-weight: 700;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* 主容器優化 */
        .main-container {
            max-width: 900px;
            margin: 40px auto;
            padding: 0 20px;
        }

        /* 卡片設計 */
        .custom-card {
            background: var(--card-bg);
            border-radius: 16px;
            box-shadow: var(--shadow-lg);
            border: none;
            padding: 40px;
            transition: transform 0.2s ease;
        }

        .section-title {
            font-weight: 700;
            color: #111827;
            margin-bottom: 10px;
            position: relative;
            display: inline-block;
        }
        
        .section-title::after {
            content: '';
            display: block;
            width: 40%;
            height: 4px;
            background: var(--primary-color);
            margin-top: 8px;
            border-radius: 2px;
        }

        /* 表單優化 */
        .form-label {
            font-weight: 500;
            color: #374151;
            margin-bottom: 8px;
        }

        .form-control, .form-select {
            border-radius: 8px;
            border: 1px solid #d1d5db;
            padding: 12px;
            font-size: 0.95rem;
            transition: all 0.2s;
        }

        .form-control:focus, .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        /* 按鈕優化 */
        .btn-primary {
            background-color: var(--primary-color);
            border: none;
            border-radius: 8px;
            padding: 12px 30px;
            font-weight: 600;
            letter-spacing: 0.5px;
            box-shadow: 0 4px 6px rgba(79, 70, 229, 0.2);
            transition: all 0.2s;
        }

        .btn-primary:hover {
            background-color: var(--primary-hover);
            transform: translateY(-1px);
            box-shadow: 0 6px 8px rgba(79, 70, 229, 0.3);
        }

        /* Loading 遮罩優化 */
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.95);
            z-index: 9999;
            display: none; /* 預設隱藏，由 JS 控制顯示 */
            justify-content: center;
            align-items: center;
            flex-direction: column;
            backdrop-filter: blur(5px);
        }

        .loading-content {
            text-align: center;
            animation: fadeIn 0.5s ease;
        }

        /* 題目卡片 */
        .question-card {
            border: 1px solid #e5e7eb;
            border-left: 5px solid var(--primary-color);
            background: #f9fafb;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 25px;
        }

        .options-list .form-check {
            background: white;
            border: 1px solid #e5e7eb;
            padding: 15px 15px 15px 45px;
            border-radius: 8px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .options-list .form-check:hover {
            border-color: var(--primary-color);
            background: #eef2ff;
        }

        .form-check-input:checked + .form-check-label {
            color: var(--primary-color);
            font-weight: 700;
        }

        /* 進度條 */
        .progress {
            height: 8px;
            border-radius: 4px;
            background-color: #e5e7eb;
            overflow: hidden;
        }
        
        .progress-bar {
            background-color: var(--primary-color);
            transition: width 0.4s ease;
        }

        /* 診斷報告 */
        .diagnostic-report h3 {
            color: var(--primary-color);
            margin-top: 30px;
            font-weight: 700;
            font-size: 1.4rem;
            border-bottom: 1px solid #e5e7eb;
            padding-bottom: 10px;
        }
        
        .diagnostic-report li {
            margin-bottom: 12px;
        }

        /* 動畫 */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in {
            animation: fadeIn 0.5s ease forwards;
        }
        
        /* 隱藏區塊 Helper Class */
        .d-none-custom {
            display: none !important;
        }
    </style>

    <script>
    MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']],
        displayMath: [['$$', '$$'], ['\\[', '\\]']],
        processEscapes: true
      },
      svg: {
        fontCache: 'global'
      }
    };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-svg.js"></script>
</head>
<body>

<div id="loading-overlay">
    <div class="loading-content">
        <div class="spinner-grow text-primary mb-3" role="status" style="width: 3rem; height: 3rem;">
            <span class="visually-hidden">Loading...</span>
        </div>
        <h4 class="fw-bold text-dark" id="loading-title" data-i18n="loading_title">AI 正在深度分析教材...</h4>
        <p class="text-muted" id="loading-desc" data-i18n="loading_desc">這可能需要 30-60 秒，請稍候，我們正在為您生成高品質試題。</p>
    </div>
</div>

<nav class="navbar navbar-custom">
    <div class="container-fluid max-width-900">
        <div class="main-container w-100 my-0 py-2 d-flex justify-content-between align-items-center">
            <a href="#" class="brand-logo text-decoration-none fs-4">
                <i class="bi bi-robot"></i> <span data-i18n="brand">Learning AI</span>
            </a>
            <div class="dropdown">
                <button class="btn btn-outline-primary dropdown-toggle btn-sm" type="button" id="langDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="bi bi-globe"></i> <span id="current-lang">繁體中文</span>
                </button>
                <ul class="dropdown-menu dropdown-menu-end shadow" aria-labelledby="langDropdown">
                    <li><button class="dropdown-item" onclick="setLanguage('en')">English</button></li>
                    <li><button class="dropdown-item" onclick="setLanguage('zh_cn')">简体中文</button></li>
                    <li><button class="dropdown-item" onclick="setLanguage('zh_tw')">繁體中文</button></li>
                    <li><button class="dropdown-item" onclick="setLanguage('ms')">Bahasa Melayu</button></li>
                </ul>
            </div>
        </div>
    </div>
</nav>

<div class="container main-container">

    <div id="upload-section" class="custom-card fade-in">
        <h2 class="section-title" data-i18n="upload_title">教師後台：課文上傳與命題</h2>
        <p class="text-muted mb-4" data-i18n="upload_desc">請填寫課文資訊並貼上純文字內容，AI 將自動為您生成診斷試題。</p>
        
        <form id="uploadForm">
            <div class="row g-4 mb-4">
                <div class="col-md-6">
                    <label for="stage" class="form-label" data-i18n="label_stage">學習階段</label>
                    <select class="form-select" id="stage" name="stage" required onchange="updateGradeOptions()">
                        <option value="高中" selected data-i18n="opt_senior">高中 (Senior High)</option>
                        <option value="初中" data-i18n="opt_junior">初中 (Junior High)</option>
                    </select>
                </div>
                <div class="col-md-6">
                    <label for="grade" class="form-label" data-i18n="label_grade">年級</label>
                    <select class="form-select" id="grade" name="grade" required>
                        <option value="高一">Form 4 (高一)</option>
                        <option value="高二" selected>Form 5 (高二)</option>
                        <option value="高三">Form 6 (高三)</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label for="subject" class="form-label" data-i18n="label_subject">科目</label>
                    <input type="text" class="form-control" id="subject" name="subject" placeholder="Chemistry / Fizik" required>
                </div>
                <div class="col-md-4">
                    <label for="volume" class="form-label" data-i18n="label_volume">冊別</label>
                    <input type="text" class="form-control" id="volume" name="volume" placeholder="Vol 2">
                </div>
                <div class="col-md-4">
                    <label for="lessonNum" class="form-label" data-i18n="label_chapter">課別</label>
                    <input type="text" class="form-control" id="lessonNum" name="lessonNum" placeholder="Chapter 5">
                </div>
                <div class="col-12">
                    <label for="lessonName" class="form-label" data-i18n="label_lesson_name">課名</label>
                    <input type="text" class="form-control" id="lessonName" name="lessonName" placeholder="Redox Reaction" required>
                </div>
            </div>

            <div class="mb-4">
                <label for="contentBody" class="form-label" data-i18n="label_content">課文內容 (純文字)</label>
                <textarea class="form-control font-monospace" id="contentBody" name="contentBody" rows="12" placeholder="..." required style="font-size: 0.9rem; background-color: #fafafa;"></textarea>
                <div class="form-text text-end"><i class="bi bi-info-circle"></i> <span data-i18n="hint_content">暫不支持圖片或 PDF，請貼上純文本。</span></div>
            </div>

            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                <button type="submit" class="btn btn-primary btn-lg">
                    <i class="bi bi-stars"></i> <span data-i18n="btn_submit">提交並生成試題</span>
                </button>
            </div>
        </form>
    </div>

    <div id="quiz-section" class="custom-card fade-in d-none-custom">
        <div class="d-flex justify-content-between align-items-center mb-4">
             <div>
                 <h3 id="quiz-title" class="mb-1 fw-bold">隨堂測驗</h3>
                 <small class="text-muted" id="quiz-subtitle">請仔細作答，AI 將分析您的概念理解。</small>
             </div>
             <span class="badge bg-primary fs-6 rounded-pill px-3 py-2" id="progress-badge">1 / 10</span>
        </div>
        
        <div class="progress mb-4">
            <div class="progress-bar" id="progress-bar-visual" role="progressbar" style="width: 0%"></div>
        </div>

        <div id="question-container" class="fade-in">
            </div>

        <div class="d-flex justify-content-end mt-4 pt-3 border-top">
            <button id="next-btn" class="btn btn-primary px-5">
                <span data-i18n="btn_next">下一題</span> <i class="bi bi-arrow-right"></i>
            </button>
        </div>
    </div>

    <div id="result-section" class="custom-card fade-in d-none-custom">
         <div class="text-center mb-5">
            <div class="mb-3">
                <i class="bi bi-clipboard-pulse text-primary" style="font-size: 4rem;"></i>
            </div>
            <h2 class="fw-bold" data-i18n="result_title">測驗結果與 AI 診斷報告</h2>
            <p class="text-muted" data-i18n="result_desc">以下是您的專屬學習診療醫師為您提供的分析。</p>
            
            <div class="d-inline-block bg-light px-5 py-3 rounded-4 mt-3 border">
                <div class="display-4 fw-bold text-primary" id="score-display">-- / 100</div>
                <small class="text-secondary fw-bold text-uppercase">Score (MCQ)</small>
            </div>
        </div>

        <div class="card border-0 shadow-sm">
            <div class="card-header bg-primary text-white fw-bold py-3">
                <i class="bi bi-activity"></i> <span data-i18n="report_header">AI 醫師診斷報告 (Dr. AI Diagnostic Report)</span>
            </div>
            <div class="card-body diagnostic-report p-4" id="diagnostic-content">
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="mt-2 text-muted">正在撰寫病歷表...</p>
                </div>
            </div>
        </div>

        <div class="text-center mt-5">
             <button class="btn btn-outline-primary px-4 py-2 rounded-pill" onclick="location.reload()">
                <i class="bi bi-arrow-counterclockwise"></i> <span data-i18n="btn_restart">返回首頁 (開始新測驗)</span>
             </button>
        </div>
    </div>

</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
// ================= 多語系設定 (Frontend i18n) =================
const translations = {
    'zh_tw': {
        brand: "Learning AI",
        loading_title: "AI 正在深度分析教材...",
        loading_desc: "這可能需要 30-60 秒，請稍候，我們正在為您生成高品質試題。",
        upload_title: "教師後台：課文上傳與命題",
        upload_desc: "請填寫課文資訊並貼上純文字內容，AI 將自動為您生成診斷試題。",
        label_stage: "學習階段",
        label_grade: "年級",
        label_subject: "科目",
        label_volume: "冊別",
        label_chapter: "課別",
        label_lesson_name: "課名",
        label_content: "課文內容 (純文字)",
        opt_senior: "高中 (Senior High)",
        opt_junior: "初中 (Junior High)",
        hint_content: "暫不支持圖片或 PDF，請貼上純文本。",
        btn_submit: "提交並生成試題",
        btn_next: "下一題",
        btn_result: "查看結果 (提交)",
        result_title: "測驗結果與 AI 診斷報告",
        result_desc: "以下是您的專屬學習診療醫師為您提供的分析。",
        report_header: "AI 醫師診斷報告",
        btn_restart: "返回首頁"
    },
    'zh_cn': {
        brand: "Learning AI",
        loading_title: "AI 正在深度分析教材...",
        loading_desc: "这可能需要 30-60 秒，请稍候，我们正在为您生成高质量试题。",
        upload_title: "教师后台：课文上传与命题",
        upload_desc: "请填写课文资讯并贴上纯文字内容，AI 将自动为您生成诊断试题。",
        label_stage: "学习阶段",
        label_grade: "年级",
        label_subject: "科目",
        label_volume: "册别",
        label_chapter: "课别",
        label_lesson_name: "课名",
        label_content: "课文内容 (纯文字)",
        opt_senior: "高中 (Senior High)",
        opt_junior: "初中 (Junior High)",
        hint_content: "暂不支持图片或 PDF，请贴上纯文本。",
        btn_submit: "提交并生成试题",
        btn_next: "下一题",
        btn_result: "查看结果 (提交)",
        result_title: "测验结果与 AI 诊断报告",
        result_desc: "以下是您的专属学习诊疗医师为您提供的分析。",
        report_header: "AI 医师诊断报告",
        btn_restart: "返回首页"
    },
    'en': {
        brand: "Learning AI",
        loading_title: "AI is analyzing the content...",
        loading_desc: "This may take 30-60 seconds. Please wait while we generate high-quality questions.",
        upload_title: "Teacher Portal: Upload & Generate",
        upload_desc: "Please fill in the details and paste the text content. AI will generate diagnostic questions automatically.",
        label_stage: "Education Stage",
        label_grade: "Grade",
        label_subject: "Subject",
        label_volume: "Volume",
        label_chapter: "Chapter",
        label_lesson_name: "Lesson Name",
        label_content: "Content (Text Only)",
        opt_senior: "Senior High",
        opt_junior: "Junior High",
        hint_content: "Images or PDFs are not supported yet. Please paste plain text.",
        btn_submit: "Submit & Generate",
        btn_next: "Next Question",
        btn_result: "View Results (Submit)",
        result_title: "Quiz Results & AI Diagnosis",
        result_desc: "Here is the analysis provided by your AI Learning Doctor.",
        report_header: "Dr. AI Diagnostic Report",
        btn_restart: "Back to Home"
    },
    'ms': {
        brand: "Learning AI",
        loading_title: "AI sedang menganalisis kandungan...",
        loading_desc: "Ini mungkin mengambil masa 30-60 saat. Sila tunggu sementara kami menjana soalan.",
        upload_title: "Portal Guru: Muat Naik & Jana",
        upload_desc: "Sila isi butiran dan tampal kandungan teks. AI akan menjana soalan diagnostik secara automatik.",
        label_stage: "Peringkat",
        label_grade: "Tingkatan",
        label_subject: "Subjek",
        label_volume: "Jilid",
        label_chapter: "Bab",
        label_lesson_name: "Nama Pelajaran",
        label_content: "Kandungan (Teks Sahaja)",
        opt_senior: "Sekolah Menengah Atas",
        opt_junior: "Sekolah Menengah Rendah",
        hint_content: "Imej atau PDF belum disokong. Sila tampal teks biasa.",
        btn_submit: "Hantar & Jana",
        btn_next: "Soalan Seterusnya",
        btn_result: "Lihat Keputusan",
        result_title: "Keputusan Kuiz & Diagnosis AI",
        result_desc: "Berikut adalah analisis yang disediakan oleh Doktor Pembelajaran AI anda.",
        report_header: "Laporan Diagnostik Dr. AI",
        btn_restart: "Kembali ke Utama"
    }
};

let currentLang = 'zh_tw';

function setLanguage(lang) {
    currentLang = lang;
    const t = translations[lang];
    // Update text for elements with data-i18n attribute
    $('[data-i18n]').each(function() {
        const key = $(this).data('i18n');
        if (t[key]) {
            $(this).text(t[key]);
        }
    });
    // Update placeholders
    $('#subject').attr('placeholder', lang === 'en' ? 'Chemistry' : '例如：化學');
    $('#contentBody').attr('placeholder', t.hint_content);
    
    // Update Dropdown Text
    const langNames = {'zh_tw': '繁體中文', 'zh_cn': '简体中文', 'en': 'English', 'ms': 'Bahasa Melayu'};
    $('#current-lang').text(langNames[lang]);
}

// ================= 邏輯連動：年級選單 =================
function updateGradeOptions() {
    const stage = document.getElementById('stage').value;
    const gradeSelect = document.getElementById('grade');
    gradeSelect.innerHTML = ''; // 清空選項

    let options = [];
    if (stage === '高中' || stage === 'Senior High') {
        options = [
            {val: '高一', text: 'Form 4 (高一)'},
            {val: '高二', text: 'Form 5 (高二)'},
            {val: '高三', text: 'Form 6 (高三)'}
        ];
    } else {
        options = [
            {val: '初一', text: 'Form 1 (初一)'},
            {val: '初二', text: 'Form 2 (初二)'},
            {val: '初三', text: 'Form 3 (初三)'}
        ];
    }

    options.forEach(opt => {
        const el = document.createElement('option');
        el.value = opt.val;
        el.innerText = opt.text;
        gradeSelect.appendChild(el);
    });
    // 預設選第二個
    gradeSelect.selectedIndex = 1; 
}


// ================= 全域變數控制考試流程 =================
let currentQuizData = [];
let currentQuestionIndex = 0;
let studentAnswers = [];
let currentLessonId = null;

$(document).ready(function() {
    // 初始化語言
    setLanguage('zh_tw');
    
    // 綁定上傳表單提交事件
    $('#uploadForm').on('submit', function(e) {
        e.preventDefault();
        // 顯示 Loading
        $('#loading-overlay').css('display', 'flex').hide().fadeIn(300);
        
        // 獲取表單資料
        const formData = {
            stage: $('#stage').val(),
            grade: $('#grade').val(),
            subject: $('#subject').val(),
            volume: $('#volume').val(),
            lessonNum: $('#lessonNum').val(),
            lessonName: $('#lessonName').val(),
            contentBody: $('#contentBody').val()
        };

        // 呼叫後端 GAS 函數
        google.script.run
            .withSuccessHandler(function(response) {
                $('#loading-overlay').fadeOut(300); // 隱藏 Loading
                if (response.status === 'success') {
                    // 開始考試流程
                    currentLessonId = response.lessonId;
                    startQuiz(response.quizData);
                } else {
                    alert('Error: ' + response.message);
                }
            })
            .withFailureHandler(function(error) {
                $('#loading-overlay').fadeOut(300);
                alert('Server Error: ' + error.message);
            })
            .handleUpload(formData);
    });

    // 綁定下一題按鈕事件
    $('#next-btn').on('click', nextQuestion);
});


// ================= 考試流程函數 =================

// 開始考試：初始化狀態並切換介面
function startQuiz(questions) {
    currentQuizData = questions;
    currentQuestionIndex = 0;
    studentAnswers = [];
    
    // 平滑切換介面
    $('#upload-section').fadeOut(300, function() {
        $('#result-section').addClass('d-none-custom');
        $('#quiz-section').removeClass('d-none-custom').hide().fadeIn(300);
        renderQuestion();
    });
}

// 渲染當前題目
function renderQuestion() {
    const question = currentQuizData[currentQuestionIndex];
    const $container = $('#question-container');
    
    // 淡出舊題 -> 渲染新題 -> 淡入
    $container.fadeOut(200, function() {
        $container.empty(); 

        // 更新進度條
        const t = translations[currentLang];
        const progressText = `${currentQuestionIndex + 1} / ${currentQuizData.length}`;
        $('#progress-badge').text(progressText);
        const progressPercent = ((currentQuestionIndex + 1) / currentQuizData.length) * 100;
        $('#progress-bar-visual').css('width', progressPercent + '%');

        // 更新按鈕文字
        const btnText = (currentQuestionIndex === currentQuizData.length - 1) 
                        ? (t.btn_result || "查看結果 (提交)") 
                        : (t.btn_next || "下一題");
        $('#next-btn').html(`${btnText} <i class="bi bi-arrow-right"></i>`);

        let html = '';
        
        // 根據題型生成 HTML
        if (question.type === 'MCQ') {
            html = `
                <div class="question-card">
                    <div class="mb-4">
                        <span class="badge bg-info text-dark bg-opacity-25 border border-info mb-2">${question.context_tag || 'General'}</span>
                        <span class="badge bg-secondary bg-opacity-10 text-secondary border mb-2">${question.difficulty} | ${question.marks} Pts</span>
                        <h5 class="card-title fw-bold mt-2" style="font-size: 1.1rem; line-height: 1.6;">${question.question_text}</h5>
                    </div>
                    <div class="options-list">
                        ${Object.entries(question.options).map(([key, value]) => `
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="mcq-option" id="option${key}" value="${key}">
                                <label class="form-check-label w-100" for="option${key}">
                                    <strong class="text-primary me-2">${key}.</strong> ${value}
                                </label>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        } else if (question.type === 'EIQ_GROUP' || question.type === 'SAQ_GROUP') {
            html = `
                <div class="question-card">
                    <div class="mb-4">
                        <span class="badge bg-warning text-dark bg-opacity-25 border border-warning mb-2">Group Question | ${question.marks} Pts</span>
                        <h5 class="card-title fw-bold mt-2">${question.main_text}</h5>
                    </div>
                    ${question.sub_questions.map(subQ => `
                        <div class="sub-question p-3 mb-3 bg-white border rounded">
                            <label class="form-label fw-bold text-dark">${subQ.question_text} <span class="text-muted small">(${subQ.marks} pts)</span></label>
                            <textarea class="form-control" rows="3" placeholder="Enter your answer here..."></textarea>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        $container.html(html).fadeIn(200);

        // MathJax 重新渲染
        if (window.MathJax) {
            MathJax.typesetPromise && MathJax.typesetPromise([$container[0]]);
        }
    });
}

// 處理下一題邏輯
function nextQuestion() {
    const question = currentQuizData[currentQuestionIndex];
    
    // 驗證與收集答案
    if (question.type === 'MCQ') {
        const selectedOption = $('input[name="mcq-option"]:checked').val();
        if (!selectedOption) {
            // 使用 Bootstrap Toast 或簡單 Alert (這裡為了簡化維持 Alert，但可優化)
            alert('Please select an option / 請選擇一個選項');
            return;
        }
        studentAnswers.push({
            question_id: question.id,
            student_response: selectedOption
        });
    } else {
        const subAnswers = [];
        let allFilled = true;
        // V1 暫時不強制填寫非選擇題，但建議收集
        $('#question-container .sub-question').each(function() {
            const subId = $(this).data('sub-id'); // 若您的數據有 sub_id
            const textVal = $(this).find('textarea').val();
            subAnswers.push({ sub_id: subId, response: textVal });
        });
        
        studentAnswers.push({
            question_id: question.id,
            student_response: JSON.stringify(subAnswers) 
        });
    }

    // 判斷是否結束
    if (currentQuestionIndex < currentQuizData.length - 1) {
        currentQuestionIndex++;
        renderQuestion();
    } else {
        submitQuiz();
    }
}

// 提交試卷
function submitQuiz() {
    // 切換 Loading 文字
    const t = translations[currentLang];
    $('#loading-title').text("AI Doctor is analyzing..."); 
    $('#loading-desc').text("Reviewing your answers and writing diagnosis...");
    $('#loading-overlay').css('display', 'flex').hide().fadeIn(300);

    const submissionData = {
        lessonId: currentLessonId,
        studentName: 'Student V1', 
        answers: studentAnswers
    };

    google.script.run
        .withSuccessHandler(function(response) {
            $('#loading-overlay').fadeOut(300);
            if (response.status === 'success') {
                showResults(response);
            } else {
                alert('Grading Failed: ' + response.message);
            }
        })
        .withFailureHandler(function(error) {
            $('#loading-overlay').fadeOut(300);
            alert('Submission Error: ' + error.message);
        })
        .handleGrading(submissionData);
}

// 顯示結果頁面
function showResults(data) {
    $('#quiz-section').addClass('d-none-custom'); // 隱藏考試區
    $('#result-section').removeClass('d-none-custom').hide().fadeIn(500); // 顯示結果區

    $('#score-display').text(`${data.mcqScore} / 100`);
    // 插入 AI 診斷報告
    $('#diagnostic-content').html(data.diagnostic);
    
    // 滾動到頂部
    window.scrollTo({top: 0, behavior: 'smooth'});
}

</script>
</body>
</html>

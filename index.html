<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Learning AI Platform | 智能學習診斷系統</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    
    <style>
        :root {
            --primary-color: #4f46e5;
            --primary-hover: #4338ca;
            --bg-color: #f3f4f6;
            --card-bg: #ffffff;
        }
        body { background-color: var(--bg-color); font-family: 'Inter', 'Noto Sans TC', sans-serif; color: #1f2937; line-height: 1.6; }
        .navbar-custom { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border-bottom: 1px solid rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 1000; }
        .brand-logo { font-weight: 700; color: var(--primary-color); display: flex; align-items: center; gap: 10px; }
        .main-container { max-width: 900px; margin: 40px auto; padding: 0 20px; }
        .custom-card { background: var(--card-bg); border-radius: 16px; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); border: none; padding: 40px; margin-bottom: 30px; }
        .section-title { font-weight: 700; color: #111827; margin-bottom: 20px; position: relative; display: inline-block; }
        .section-title::after { content: ''; display: block; width: 50px; height: 4px; background: var(--primary-color); margin-top: 8px; border-radius: 2px; }
        .form-control, .form-select { border-radius: 10px; padding: 12px; border: 1px solid #d1d5db; }
        .form-control:focus, .form-select:focus { border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1); }
        .btn-primary { background-color: var(--primary-color); border: none; border-radius: 10px; padding: 12px 30px; font-weight: 600; transition: all 0.2s; }
        .btn-primary:hover { background-color: var(--primary-hover); transform: translateY(-2px); }
        .question-card { border-left: 5px solid var(--primary-color); background: #f9fafb; padding: 25px; border-radius: 12px; margin-bottom: 20px; }
        .form-check { background: white; border: 1px solid #e5e7eb; padding: 15px 15px 15px 45px; border-radius: 8px; margin-bottom: 10px; cursor: pointer; transition: all 0.2s; }
        .form-check:hover { border-color: var(--primary-color); background: #eef2ff; }
        .form-check-input:checked + .form-check-label { color: var(--primary-color); font-weight: 700; }
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.95); z-index: 9999; display: none; justify-content: center; align-items: center; flex-direction: column; }
        .d-none-custom { display: none !important; }
        .fade-in { animation: fadeIn 0.5s ease forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        /* Diagnostic Report Styles */
        .diagnostic-report h3 { color: var(--primary-color); margin-top: 25px; font-weight: 700; font-size: 1.25rem; border-bottom: 1px solid #eee; padding-bottom: 8px; }
        .diagnostic-report ul { padding-left: 20px; color: #4b5563; }
        .diagnostic-report li { margin-bottom: 8px; }
    </style>

    <script>MathJax = { tex: { inlineMath: [['$', '$'], ['\\(', '\\)']] }, svg: { fontCache: 'global' } };</script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-svg.js"></script>
</head>
<body>

<div id="loading-overlay">
    <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;" role="status"></div>
    <h4 class="fw-bold text-dark" id="loading-title" data-i18n="loading_title">AI 正在深度分析教材...</h4>
    <p class="text-muted" id="loading-desc" data-i18n="loading_desc">這可能需要 30-60 秒，請稍候...</p>
</div>

<nav class="navbar navbar-custom">
    <div class="container-fluid max-width-900">
        <div class="main-container w-100 my-0 py-2 d-flex justify-content-between align-items-center">
            <a href="#" class="brand-logo text-decoration-none fs-4" onclick="location.reload()">
                <i class="bi bi-robot"></i> <span data-i18n="brand">Learning AI</span>
            </a>
            <div class="dropdown">
                <button class="btn btn-outline-primary dropdown-toggle btn-sm" type="button" id="langDropdown" data-bs-toggle="dropdown">
                    <i class="bi bi-globe"></i> <span id="current-lang-text">繁體中文</span>
                </button>
                <ul class="dropdown-menu dropdown-menu-end shadow">
                    <li><button class="dropdown-item lang-select" data-lang="en">English</button></li>
                    <li><button class="dropdown-item lang-select" data-lang="zh_cn">简体中文</button></li>
                    <li><button class="dropdown-item lang-select" data-lang="zh_tw">繁體中文</button></li>
                    <li><button class="dropdown-item lang-select" data-lang="ms">Bahasa Melayu</button></li>
                </ul>
            </div>
        </div>
    </div>
</nav>

<div class="container main-container">

    <div id="upload-section" class="custom-card fade-in">
        <h2 class="section-title" data-i18n="upload_title">教師後台：課文上傳與命題</h2>
        <p class="text-muted mb-4" data-i18n="upload_desc">請填寫課文資訊並貼上純文字內容，AI 將自動為您生成診斷試題。</p>
        
        <form id="uploadForm">
            <div class="row g-4 mb-4">
                <div class="col-md-6">
                    <label for="stage" class="form-label" data-i18n="label_stage">學習階段</label>
                    <select class="form-select" id="stage" name="stage" required>
                        <option value="高中" selected data-i18n="opt_senior">高中 (Senior High)</option>
                        <option value="初中" data-i18n="opt_junior">初中 (Junior High)</option>
                    </select>
                </div>
                <div class="col-md-6">
                    <label for="grade" class="form-label" data-i18n="label_grade">年級</label>
                    <select class="form-select" id="grade" name="grade" required>
                        </select>
                </div>
                <div class="col-md-4">
                    <label for="subject" class="form-label" data-i18n="label_subject">科目</label>
                    <input type="text" class="form-control" id="subject" name="subject" placeholder="Chemistry" required>
                </div>
                <div class="col-md-4">
                    <label for="volume" class="form-label" data-i18n="label_volume">冊別</label>
                    <input type="text" class="form-control" id="volume" name="volume" placeholder="Vol 2">
                </div>
                <div class="col-md-4">
                    <label for="lessonNum" class="form-label" data-i18n="label_chapter">課別</label>
                    <input type="text" class="form-control" id="lessonNum" name="lessonNum" placeholder="Ch 5">
                </div>
                <div class="col-12">
                    <label for="lessonName" class="form-label" data-i18n="label_lesson_name">課名</label>
                    <input type="text" class="form-control" id="lessonName" name="lessonName" placeholder="Redox Reaction" required>
                </div>
            </div>

            <div class="mb-4">
                <label for="contentBody" class="form-label" data-i18n="label_content">課文內容 (純文字)</label>
                <textarea class="form-control font-monospace" id="contentBody" name="contentBody" rows="12" placeholder="..." required style="background-color: #fafafa; font-size: 0.9rem;"></textarea>
                <div class="form-text text-end"><i class="bi bi-info-circle"></i> <span data-i18n="hint_content">暫不支持圖片或 PDF，請貼上純文本。</span></div>
            </div>

            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                <button type="submit" class="btn btn-primary btn-lg px-5">
                    <i class="bi bi-stars"></i> <span data-i18n="btn_submit">提交並生成試題</span>
                </button>
            </div>
        </form>
    </div>

    <div id="quiz-section" class="custom-card fade-in d-none-custom">
        <div class="d-flex justify-content-between align-items-center mb-4">
             <div>
                 <h3 id="quiz-title" class="mb-1 fw-bold">隨堂測驗</h3>
                 <small class="text-muted" data-i18n="quiz_subtitle">請仔細作答，AI 將分析您的概念理解。</small>
             </div>
             <span class="badge bg-primary fs-6 rounded-pill px-3 py-2" id="progress-badge">1 / 10</span>
        </div>
        
        <div class="progress mb-4" style="height: 8px;">
            <div class="progress-bar" id="progress-bar-visual" role="progressbar" style="width: 0%"></div>
        </div>

        <div id="question-container"></div>

        <div class="d-flex justify-content-end mt-4 pt-3 border-top">
            <button id="next-btn" class="btn btn-primary px-5">
                <span data-i18n="btn_next">下一題</span> <i class="bi bi-arrow-right"></i>
            </button>
        </div>
    </div>

    <div id="result-section" class="custom-card fade-in d-none-custom">
         <div class="text-center mb-5">
            <div class="mb-3"><i class="bi bi-clipboard-pulse text-primary" style="font-size: 4rem;"></i></div>
            <h2 class="fw-bold" data-i18n="result_title">測驗結果與 AI 診斷報告</h2>
            <p class="text-muted" data-i18n="result_desc">以下是您的專屬學習診療醫師為您提供的分析。</p>
            
            <div class="d-inline-block bg-light px-5 py-3 rounded-4 mt-3 border">
                <div class="display-4 fw-bold text-primary" id="score-display">-- / 100</div>
                <small class="text-secondary fw-bold text-uppercase">Score (MCQ)</small>
            </div>
        </div>

        <div class="card border-0 shadow-sm">
            <div class="card-header bg-primary text-white fw-bold py-3">
                <i class="bi bi-activity"></i> <span data-i18n="report_header">AI 醫師診斷報告</span>
            </div>
            <div class="card-body diagnostic-report p-4" id="diagnostic-content">
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="mt-2 text-muted">正在撰寫病歷表...</p>
                </div>
            </div>
        </div>

        <div class="text-center mt-5">
             <button class="btn btn-outline-primary px-4 py-2 rounded-pill" onclick="location.reload()">
                <i class="bi bi-arrow-counterclockwise"></i> <span data-i18n="btn_restart">返回首頁</span>
             </button>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
// ==========================================
// ⚠️ 您的真實 GAS 網址 (已預先填入)
// ==========================================
const GAS_API_URL = 'https://script.google.com/macros/s/AKfycbxfXHBE_m2123QWM5sM9-uH0LcaX5lLyoLJmKRR1QHFh1yiQOXUbsYQhlOZZNs7H4FWjA/exec';

let currentQuizData = [];
let currentQuestionIndex = 0;
let studentAnswers = [];
let currentLessonId = null;
let currentLang = 'zh_tw'; 

const translations = {
    'zh_tw': {
        brand: "Learning AI", loading_title: "AI 正在深度分析教材...", loading_desc: "這可能需要 30-60 秒...",
        upload_title: "教師後台：課文上傳與命題", upload_desc: "請填寫課文並貼上內容，AI 將生成診斷試題。",
        label_stage: "學習階段", label_grade: "年級", label_subject: "科目", label_volume: "冊別", label_chapter: "課別", label_lesson_name: "課名", label_content: "課文內容 (純文字)",
        opt_senior: "高中 (Senior High)", opt_junior: "初中 (Junior High)", hint_content: "暫不支持圖片，請貼上純文本。",
        btn_submit: "提交並生成試題", quiz_subtitle: "請仔細作答，AI 將分析您的概念理解。", btn_next: "下一題", btn_result: "提交結果",
        result_title: "測驗結果與診斷", result_desc: "AI 醫師分析報告如下。", report_header: "AI 醫師診斷報告", btn_restart: "返回首頁"
    },
    'zh_cn': {
        brand: "Learning AI", loading_title: "AI 正在分析教材...", loading_desc: "这可能需要 30-60 秒...",
        upload_title: "教师后台：上传与命题", upload_desc: "请填写课文内容，AI 将生成诊断试题。",
        label_stage: "学习阶段", label_grade: "年级", label_subject: "科目", label_volume: "册别", label_chapter: "课别", label_lesson_name: "课名", label_content: "课文内容 (纯文字)",
        opt_senior: "高中 (Senior High)", opt_junior: "初中 (Junior High)", hint_content: "请贴上纯文本。",
        btn_submit: "提交并生成", quiz_subtitle: "请仔细作答。", btn_next: "下一题", btn_result: "提交结果",
        result_title: "测验结果与诊断", result_desc: "AI 医师分析报告如下。", report_header: "AI 医师诊断报告", btn_restart: "返回首页"
    },
    'en': {
        brand: "Learning AI", loading_title: "AI Analyzing...", loading_desc: "Please wait 30-60s...",
        upload_title: "Teacher Portal", upload_desc: "Paste text, AI will generate questions.",
        label_stage: "Stage", label_grade: "Grade", label_subject: "Subject", label_volume: "Vol", label_chapter: "Ch", label_lesson_name: "Title", label_content: "Content",
        opt_senior: "Senior High", opt_junior: "Junior High", hint_content: "Text only.",
        btn_submit: "Generate Quiz", quiz_subtitle: "AI analysis in progress.", btn_next: "Next", btn_result: "Submit",
        result_title: "Results & Diagnosis", result_desc: "Here is your analysis.", report_header: "Diagnostic Report", btn_restart: "Home"
    },
    'ms': {
        brand: "Learning AI", loading_title: "AI Menganalisis...", loading_desc: "Tunggu sebentar...",
        upload_title: "Portal Guru", upload_desc: "Tampal teks untuk jana soalan.",
        label_stage: "Peringkat", label_grade: "Tingkatan", label_subject: "Subjek", label_volume: "Jilid", label_chapter: "Bab", label_lesson_name: "Tajuk", label_content: "Kandungan",
        opt_senior: "Menengah Atas", opt_junior: "Menengah Rendah", hint_content: "Teks sahaja.",
        btn_submit: "Jana Kuiz", quiz_subtitle: "Sila jawab dengan teliti.", btn_next: "Seterusnya", btn_result: "Hantar",
        result_title: "Keputusan", result_desc: "Analisis Doktor AI.", report_header: "Laporan Diagnostik", btn_restart: "Kembali"
    }
};

$(document).ready(function() {
    setLanguage('zh_tw');
    updateGradeOptions();

    // 語言切換
    $('.lang-select').on('click', function(e) {
        e.preventDefault();
        setLanguage($(this).data('lang'));
    });

    // 年級連動
    $('#stage').on('change', updateGradeOptions);

    // 表單提交
    $('#uploadForm').on('submit', function(e) {
        e.preventDefault();
        $('#loading-overlay').css('display', 'flex').hide().fadeIn(300);

        const formData = {
            stage: $('#stage').val(),
            grade: $('#grade').val(),
            subject: $('#subject').val(),
            volume: $('#volume').val(),
            lessonNum: $('#lessonNum').val(),
            lessonName: $('#lessonName').val(),
            contentBody: $('#contentBody').val(),
            userLanguage: currentLang // 關鍵：將語言傳給後端
        };

        callGAS('upload', formData, function(res) {
            $('#loading-overlay').fadeOut();
            if (res.status === 'success') {
                currentLessonId = res.lessonId;
                startQuiz(res.quizData);
            } else {
                alert('Error: ' + res.message);
            }
        });
    });

    $('#next-btn').on('click', nextQuestion);
});

function setLanguage(lang) {
    currentLang = lang;
    const t = translations[lang];
    const names = {'zh_tw': '繁體中文', 'zh_cn': '简体中文', 'en': 'English', 'ms': 'Bahasa Melayu'};
    $('#current-lang-text').text(names[lang]);
    $('[data-i18n]').each(function() {
        const k = $(this).data('i18n');
        if (t[k]) $(this).text(t[k]);
    });
}

function updateGradeOptions() {
    const stage = $('#stage').val();
    const $sel = $('#grade').empty();
    let opts = (stage.includes('高中') || stage.includes('Senior')) 
        ? [{v:'高一',t:'Form 4'}, {v:'高二',t:'Form 5'}, {v:'高三',t:'Form 6'}]
        : [{v:'初一',t:'Form 1'}, {v:'初二',t:'Form 2'}, {v:'初三',t:'Form 3'}];
    
    opts.forEach(o => $sel.append(`<option value="${o.v}">${o.t}</option>`));
    $sel.prop('selectedIndex', 1);
}

function callGAS(action, payload, cb) {
    $.ajax({
        url: GAS_API_URL, type: "POST", contentType: "text/plain; charset=utf-8", dataType: "json",
        data: JSON.stringify({ action: action, payload: payload }),
        success: cb,
        error: function(e) { $('#loading-overlay').fadeOut(); alert('Connection Failed.'); console.error(e); }
    });
}

function startQuiz(data) {
    currentQuizData = data;
    currentQuestionIndex = 0;
    studentAnswers = [];
    $('#upload-section').fadeOut(300, function() {
        $('#result-section').addClass('d-none-custom');
        $('#quiz-section').removeClass('d-none-custom').hide().fadeIn(300);
        renderQuestion();
    });
}

function renderQuestion() {
    const q = currentQuizData[currentQuestionIndex];
    const $con = $('#question-container').hide().empty();
    
    $('#progress-badge').text(`${currentQuestionIndex+1} / ${currentQuizData.length}`);
    $('#progress-bar-visual').css('width', ((currentQuestionIndex+1)/currentQuizData.length)*100 + '%');
    
    const t = translations[currentLang];
    const btnTxt = (currentQuestionIndex === currentQuizData.length - 1) ? (t.btn_result || "Submit") : (t.btn_next || "Next");
    $('#next-btn').html(`${btnTxt} <i class="bi bi-arrow-right"></i>`);

    let html = '';
    if (q.type === 'MCQ') {
        html = `<div class="question-card">
            <div class="mb-3"><span class="badge bg-secondary opacity-75">${q.difficulty || 'General'}</span> <h5 class="fw-bold mt-2">${q.question_text}</h5></div>
            <div>${Object.entries(q.options).map(([k,v])=>`
                <div class="form-check"><input class="form-check-input" type="radio" name="mcq" value="${k}" id="opt${k}"><label class="form-check-label w-100" for="opt${k}"><strong>${k}.</strong> ${v}</label></div>
            `).join('')}</div></div>`;
    } else {
        html = `<div class="question-card"><h5 class="fw-bold">${q.main_text}</h5>
            ${(q.sub_questions||[]).map(sq=>`<div class="mb-3"><label class="fw-bold">${sq.question_text}</label><textarea class="form-control" rows="2"></textarea></div>`).join('')}
        </div>`;
    }
    
    $con.html(html).fadeIn(200);
    if(window.MathJax) MathJax.typesetPromise([$con[0]]);
}

function nextQuestion() {
    const q = currentQuizData[currentQuestionIndex];
    if (q.type === 'MCQ') {
        const val = $('input[name="mcq"]:checked').val();
        if (!val) return alert('Please select an option.');
        studentAnswers.push({question_id: q.id, student_response: val});
    } else {
        studentAnswers.push({question_id: q.id, student_response: "Subjective Answer"});
    }

    if (currentQuestionIndex < currentQuizData.length - 1) {
        currentQuestionIndex++;
        renderQuestion();
    } else {
        submitQuiz();
    }
}

function submitQuiz() {
    $('#loading-title').text(translations[currentLang].brand);
    $('#loading-desc').text("AI Doctor is analyzing results...");
    $('#loading-overlay').fadeIn();

    const data = {
        lessonId: currentLessonId,
        studentName: 'Student V4',
        answers: studentAnswers,
        userLanguage: currentLang // 再次確認語言
    };

    callGAS('grading', data, function(res) {
        $('#loading-overlay').fadeOut();
        if (res.status === 'success') {
            $('#quiz-section').addClass('d-none-custom');
            $('#result-section').removeClass('d-none-custom').hide().fadeIn(500);
            $('#score-display').text(`${res.mcqScore} / 100`);
            $('#diagnostic-content').html(res.diagnostic);
            window.scrollTo({top:0, behavior:'smooth'});
        } else {
            alert('Grading Error: ' + res.message);
        }
    });
}
</script>
</body>
</html>
